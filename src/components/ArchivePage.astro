---
import Layout from '@/layouts/Layout.astro';
import { useTranslatedPath, useTranslations } from '@/i18n/utils';
import { albumsService } from '@/services/albums.service';
import PostGrid from '@/components/PostGrid.astro';
import Pagination from '@/components/Pagination.astro';
import Header from '@/components/Header.astro';
import SearchField from '@/components/SearchField.astro';
import StructuredData from '@/components/StructuredData.astro';
import { getCollectionPageSchema } from '@/lib/site-metadata';

interface Props {
  locale: 'en' | 'nl';
}

const { locale } = Astro.props;

const t = useTranslations(locale);
const translatePath = useTranslatedPath(locale);

const searchParam = Astro.url.searchParams.get('search') || '';
const rawCurrentPage = Number.parseInt(
  Astro.url.searchParams.get('page') || '1',
  10
);
const currentPage = Number.isFinite(rawCurrentPage) && rawCurrentPage > 0
  ? rawCurrentPage
  : 1;
const POSTS_PER_PAGE = 15;

const { albums, pagination } = await albumsService.searchAlbums({
  start: (currentPage - 1) * POSTS_PER_PAGE,
  limit: POSTS_PER_PAGE,
  searchTerm: searchParam || undefined,
});

const totalPages = Math.ceil(pagination.total / POSTS_PER_PAGE);
const archiveRoute = `${translatePath('/archive')}/`;
const collectionPageSchema = getCollectionPageSchema(locale);
const siteUrl = Astro.site?.toString().replace(/\/$/, '') || 'https://behangmotief.be';
const canonicalArchiveUrl = `${siteUrl}${archiveRoute}`;
const isFiltered = Boolean(searchParam);
const isPaginated = currentPage > 1;
---

<Layout
  title={t('archive.title')}
  description={t('archive.description')}
  locale={locale}
  canonicalUrl={canonicalArchiveUrl}
  noindex={isFiltered || isPaginated}
>
  <StructuredData slot="structured-data" schema={collectionPageSchema} />

  <Header />
  <main class="container mx-auto px-4 md:px-0 py-8">
    <SearchField currentSearch={searchParam} archiveRoute={archiveRoute} />

    {searchParam && albums.length === 0 ? (
      <div class="text-center py-16">
        <h2 class="text-2xl font-bold mb-4">{t('search.no.results.title')}</h2>
        <p class="text-gray-600 max-w-md mx-auto">
          {t('search.no.results.message').replace('{searchTerm}', searchParam)}
        </p>
      </div>
    ) : (
      <PostGrid posts={albums} loading="eager" />
    )}

    <div class="my-12">
      <Pagination
        currentPage={currentPage}
        totalPages={totalPages}
        baseUrl={archiveRoute}
      />
    </div>
  </main>
</Layout>
