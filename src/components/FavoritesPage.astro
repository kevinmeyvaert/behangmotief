---
import Header from '@/components/Header.astro';
import Layout from '@/layouts/Layout.astro';
import { useTranslatedPath, useTranslations } from '@/i18n/utils';

interface Props {
  locale: 'en' | 'nl';
}

const { locale } = Astro.props;
const t = useTranslations(locale);
const translatePath = useTranslatedPath(locale);
const archivePath = `${translatePath('/archive')}/`;
const albumBasePath = `${translatePath('/album')}/`;
---

<Layout
  title={t('favorites.page.title')}
  description={t('favorites.page.description')}
  locale={locale}
>
  <Header />
  <main>
    <section class="container mx-auto mb-12 px-4 md:px-0 pb-10 md:pb-14">
      <div class="mb-8 flex min-h-10 items-center gap-3">
        <a
          href={archivePath}
          class="inline-flex items-center gap-2 text-gray-500 hover:text-black transition-colors"
        >
          <span aria-hidden="true">←</span>
          {t('favorites.empty.cta')}
        </a>
      </div>

      <header>
        <h1 class="text-3xl md:text-4xl font-bold">{t('favorites.page.title')}</h1>
        <p class="mt-3 text-muted-foreground max-w-2xl">{t('favorites.page.description')}</p>
      </header>

      <section class="mt-10">
        <div
          data-favorites-empty
          class="hidden py-16 text-center"
        >
          <h2 class="text-2xl font-semibold">{t('favorites.empty.title')}</h2>
          <p class="mt-3 text-muted-foreground">{t('favorites.empty.description')}</p>
          <a
            href={archivePath}
            class="mt-6 inline-flex items-center rounded-lg bg-primary px-5 py-2.5 text-primary-foreground hover:opacity-80 transition-opacity"
          >
            {t('favorites.empty.cta')}
          </a>
        </div>

        <ul
          data-favorites-grid
          class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6"
        ></ul>
      </section>
    </section>
  </main>
</Layout>

<script
  is:inline
  type="application/json"
  data-favorites-page-config
  set:html={JSON.stringify({
    albumBasePath,
    locale,
    removeLabel: t('favorites.remove'),
    openAlbumLabel: t('favorites.open.album'),
    imageIdLabel: t('favorites.image.id'),
    removeAriaLabel: t('favorites.remove.aria'),
  })}
/>

<script>
  import {
    FAVORITES_CHANGED_EVENT,
    FAVORITES_STORAGE_KEY,
    getFavorites,
    removeFavorite,
  } from '@/lib/favorites';
  import { formatPostDate } from '@/lib/date';

  const configEl = document.querySelector('[data-favorites-page-config]');
  if (configEl instanceof HTMLScriptElement) {
    type FavoritesPageConfig = {
      albumBasePath?: string;
      locale?: string;
      removeLabel?: string;
      openAlbumLabel?: string;
      imageIdLabel?: string;
      removeAriaLabel?: string;
    };
    type PostHogCapture = {
      capture?: (eventName: string, properties?: Record<string, unknown>) => void;
    };

    const config = JSON.parse(configEl.textContent || '{}') as FavoritesPageConfig;
    const favoritesGrid = document.querySelector('[data-favorites-grid]');
    const emptyState = document.querySelector('[data-favorites-empty]');
    const posthog = (window as Window & { posthog?: PostHogCapture }).posthog;

    if (favoritesGrid instanceof HTMLElement && emptyState instanceof HTMLElement) {
      const albumBasePath = String(config.albumBasePath || '/');
      const removeLabel = String(config.removeLabel || 'Remove');
      const openAlbumLabel = String(config.openAlbumLabel || 'Open album');
      const imageIdLabel = String(config.imageIdLabel || 'Image ID');
      const removeAriaLabel = String(
        config.removeAriaLabel || 'Remove photo from favorites'
      );

      const withTrailingSlash = (value: string) =>
        value.endsWith('/') ? value : `${value}/`;
      const normalizedAlbumBasePath = withTrailingSlash(albumBasePath);

      const buildAlbumHref = (slug: string) => {
        const safeSlug = String(slug || '').replace(/^\/+|\/+$/g, '');
        return `${normalizedAlbumBasePath}${safeSlug}/`;
      };

      const formatFavoriteDate = (rawDate: string) => {
        const raw = String(rawDate || '').trim();
        if (!raw) return '';

        const parsed = new Date(raw);
        if (Number.isNaN(parsed.getTime())) return raw;

        return formatPostDate(parsed.toISOString());
      };

      const renderFavorites = () => {
        const favorites = getFavorites();
        favoritesGrid.innerHTML = '';
        emptyState.classList.toggle('hidden', favorites.length > 0);
        favoritesGrid.classList.toggle('hidden', favorites.length === 0);

        favorites.forEach((favorite) => {
          const listItem = document.createElement('li');
          listItem.className = 'group relative';

          const article = document.createElement('article');
          article.className = 'relative overflow-hidden';
          article.style.boxShadow = '0 30px 60px -10px rgba(0, 0, 0, 0.2)';

          const albumLink = document.createElement('a');
          albumLink.href = buildAlbumHref(favorite.albumSlug);
          albumLink.className = 'block';
          albumLink.setAttribute('aria-label', openAlbumLabel);

          const image = document.createElement('img');
          image.src = favorite.thumbUrl;
          image.alt = `${favorite.artistName} at ${favorite.venueName}`;
          image.width = Number(favorite.width || 500);
          image.height = Number(favorite.height || 500);
          image.loading = 'lazy';
          image.className =
            'aspect-square w-full object-cover transition-transform duration-300 group-hover:scale-105';
          albumLink.appendChild(image);

          const overlay = document.createElement('div');
          overlay.className =
            'absolute inset-0 bg-gradient-to-t from-black/50 to-transparent pointer-events-none';

          const meta = document.createElement('div');
          meta.className =
            'absolute bottom-0 left-0 right-0 p-4 text-white';

          const title = document.createElement('h3');
          title.className = 'font-bold uppercase text-sm md:text-base truncate';
          title.textContent = favorite.artistName;

          const subtitle = document.createElement('p');
          subtitle.className = 'text-xs md:text-sm opacity-75 truncate';
          subtitle.textContent = `${favorite.venueName} — ${formatFavoriteDate(favorite.date)}`;

          const identifier = document.createElement('p');
          identifier.className = 'mt-1 text-[11px] leading-tight opacity-80 font-mono break-all';
          identifier.textContent = `${imageIdLabel}: ${favorite.imageId}`;

          meta.append(title, subtitle, identifier);

          const removeButton = document.createElement('button');
          removeButton.type = 'button';
          removeButton.className =
            'absolute right-2 top-2 z-10 inline-flex h-8 w-8 cursor-pointer items-center justify-center rounded-full border border-white/30 bg-black/50 text-white transition-colors hover:bg-black/70 focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-white/70 focus-visible:ring-offset-2 focus-visible:ring-offset-black';
          removeButton.innerHTML =
            '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" class="h-4 w-4" stroke="currentColor" stroke-width="2" fill="none" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12"/></svg>';
          removeButton.setAttribute('aria-label', removeAriaLabel);
          removeButton.setAttribute('title', removeLabel);
          removeButton.addEventListener('click', (event) => {
            event.preventDefault();
            event.stopPropagation();
            const nextFavorites = removeFavorite(favorite.imageId);
            posthog?.capture?.('favorite_removed', {
              image_id: favorite.imageId,
              album_slug: favorite.albumSlug,
              total_favorites: nextFavorites.length,
            });
          });

          article.append(albumLink, overlay, meta, removeButton);
          listItem.appendChild(article);
          favoritesGrid.appendChild(listItem);
        });
      };

      renderFavorites();

      posthog?.capture?.('favorites_page_viewed', {
        total_favorites: getFavorites().length,
        locale: config.locale || null,
      });

      window.addEventListener(FAVORITES_CHANGED_EVENT, renderFavorites);
      window.addEventListener('storage', (event) => {
        if (event.key === FAVORITES_STORAGE_KEY) {
          renderFavorites();
        }
      });
    }
  }
</script>
