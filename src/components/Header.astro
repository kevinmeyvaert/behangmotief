---
import { Image } from 'astro:assets';
import { getLangFromUrl, useTranslations } from '../i18n/utils';
import Navigation from './Navigation.astro';

interface Props {
  theme?: 'light' | 'dark';
  absolute?: boolean;
}

const { theme = 'light', absolute = false } = Astro.props;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const homePath = `/${lang}/`;
---

<header
  class:list={[
    absolute
      ? 'absolute top-0 left-0 right-0 z-20'
      : undefined,
  ]}
>
  <div class="container mx-auto px-4 md:px-0">
    <div class="flex justify-between items-center h-[150px]">
      <a href={homePath}>
        <div class="flex items-center">
          <Image
            src="/logo.svg"
            width={80}
            height={55}
            alt="Behangmotief"
            loading="eager"
            class={theme === 'dark' ? 'brightness-0 invert' : undefined}
          />
          <p
            class:list={[
              'ml-2 text-xs sm:text-sm',
              theme === 'dark' ? 'text-white' : undefined,
            ]}
          >
            {t('nav.photographer.tagline')}
          </p>
        </div>
      </a>
      <div class="flex items-center gap-4">
        <Navigation theme={theme} />
        <div data-user-menu class="flex items-center"></div>
      </div>
    </div>
  </div>
</header>

<script>
  import { supabase } from '@/lib/supabase';

  const userMenu = document.querySelector('[data-user-menu]');
  if (userMenu instanceof HTMLElement) {
    supabase.auth.getUser().then(({ data: { user } }) => {
      if (!user) return;

      const avatar = document.createElement('img');
      avatar.src = user.user_metadata?.avatar_url || '';
      avatar.alt = user.user_metadata?.full_name || '';
      avatar.className = 'h-8 w-8 rounded-full object-cover';
      avatar.referrerPolicy = 'no-referrer';

      const signOutBtn = document.createElement('button');
      signOutBtn.type = 'button';
      signOutBtn.className =
        'text-xs cursor-pointer text-gray-500 hover:text-black transition-colors';
      signOutBtn.textContent = userMenu.closest('[lang]')?.getAttribute('lang')?.startsWith('nl')
        ? 'Afmelden'
        : 'Sign out';
      signOutBtn.addEventListener('click', async () => {
        await supabase.auth.signOut();
        window.location.reload();
      });

      userMenu.append(avatar, signOutBtn);
    });
  }
</script>
