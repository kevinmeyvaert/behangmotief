---
import Layout from '../../../layouts/Layout.astro';
import { getLangFromUrl, useTranslatedPath, useTranslations } from '../../../i18n/utils';
import { albumsService } from '@/services/albums.service';
import AlbumLightbox from '@/components/AlbumLightbox.astro';
import BlurHashImage from '@/components/BlurHashImage.astro';
import RelatedContentSection from '@/components/RelatedContentSection.astro';
import Header from '@/components/Header.astro';
import StructuredData from '@/components/StructuredData.astro';
import { formatPostDate } from '@/lib/date';
import { ImageUrlBuilder } from '@/lib/image-url-builder';
import { getImageGallerySchema } from '@/lib/site-metadata';

const { slug } = Astro.params;
const lang = getLangFromUrl(Astro.url);
const t = useTranslations(lang);
const translatePath = useTranslatedPath(lang);
const archivePath = `${translatePath('/archive')}/`;

// Join the slug array into a path string
const slugPath = Array.isArray(slug) ? slug.join('/') : slug;
if (!slugPath) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}

// Fetch the album data using the service
const post = await albumsService.getAlbumBySlug(slugPath);
if (!post) {
  return new Response(null, {
    status: 404,
    statusText: 'Not found',
  });
}

const descriptionTemplates = t('album.descriptions') as string[];
const templateCount = descriptionTemplates.length || 1;
const deterministicIndex =
  slugPath.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0) %
  templateCount;
const descriptionTemplate = descriptionTemplates[deterministicIndex] || '';
const description = descriptionTemplate
  .replace('{venue}', post.venue.name)
  .replace('{artist}', post.artist.name);
const publishedDate = new Date(post.date);
const publishedTime = Number.isNaN(publishedDate.getTime())
  ? undefined
  : publishedDate.toISOString();
const publishedDateOnly = publishedTime?.split('T')[0];
const albumOgImage = post.images[0]
  ? ImageUrlBuilder.hero(post.images[0].hires)
  : undefined;
const albumOgImageAlt = `${post.artist.name} at ${post.venue.name}`;

// Generate ImageGallery structured data for the album
const imageGallerySchema = getImageGallerySchema(
  {
    title: `${post.artist.name} at ${post.venue.name}`,
    description,
    date: publishedDateOnly,
    artist: post.artist.name,
    venue: post.venue.name,
    images: post.images.slice(0, 10).map((img) => ({
      url: ImageUrlBuilder.hero(img.hires),
      alt: `${post.artist.name} at ${post.venue.name}`,
      width: img.dimensions?.width || 1920,
      height: img.dimensions?.height || 1280,
    })),
  },
  lang as 'nl' | 'en'
);
---

<Layout
  title={`${post.artist.name} live at ${post.venue.name} | Behangmotief`}
  description={description}
  locale={lang}
  ogType="article"
  ogImage={albumOgImage}
  ogImageAlt={albumOgImageAlt}
  publishedTime={publishedTime}
>
  <StructuredData slot="structured-data" schema={imageGallerySchema} />

  <Header />
  <main>
    <article>
      <section class="container mx-auto mb-12 px-4 md:px-0">
        <a
          href={archivePath}
          data-archive-root={archivePath}
          data-back-link
          class="inline-flex items-center gap-2 mb-8 text-gray-500 hover:text-black transition-colors"
        >
          <span aria-hidden="true">←</span>
          {t('album.back')}
        </a>
        <header class="text-center mb-12">
          <h1 class="text-4xl font-bold">{post.artist.name}</h1>
          <p class="text-gray-500">
            <time>{formatPostDate(post.date)}</time> – {post.venue.name}
          </p>
        </header>

        <div class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4 mb-24">
          {
            post.images.map((image) => (
              <div
                class="aspect-square overflow-hidden cursor-pointer"
                style={{
                  boxShadow: '0 30px 60px -10px rgba(0, 0, 0, 0.2)',
                }}
                data-album-image-trigger
                data-image-id={image.id}
                data-full-image={ImageUrlBuilder.hero(image.hires)}
                data-blurhash={image.blurhash}
                data-width={image.dimensions?.width || 800}
                data-height={image.dimensions?.height || 800}
              >
                <BlurHashImage
                  src={ImageUrlBuilder.square(image.hires, 500)}
                  alt={`${post.artist.name} at ${post.venue.name}`}
                  width={500}
                  height={500}
                  blurhash={image.blurhash}
                  class="w-full h-full object-cover hover:scale-105 transition-transform duration-300"
                  loading="eager"
                />
              </div>
            ))
          }
        </div>
        <AlbumLightbox 
          images={post.images}
          artistName={post.artist.name}
          venueName={post.venue.name}
        />
      </section>
      <RelatedContentSection server:defer post={post} locale={lang} />
    </article>
  </main>
  <script>
    const backLink = document.querySelector('[data-back-link]');

    if (backLink instanceof HTMLAnchorElement) {
      const archiveRoot = backLink.dataset.archiveRoot || '/';
      const withTrailingSlash = (value: string) =>
        value.endsWith('/') ? value : `${value}/`;
      const normalizedArchiveRoot = withTrailingSlash(archiveRoot);
      const toArchivePath = (candidate: string | null) => {
        if (!candidate) return null;

        try {
          const parsed = new URL(candidate, window.location.origin);
          const parsedPathname = withTrailingSlash(parsed.pathname);

          if (
            parsed.origin === window.location.origin &&
            parsedPathname.startsWith(normalizedArchiveRoot)
          ) {
            return `${parsed.pathname}${parsed.search}${parsed.hash}`;
          }

          return null;
        } catch {
          return null;
        }
      };

      backLink.addEventListener('click', (event) => {
        if (window.history.length > 1) {
          event.preventDefault();
          const archiveReferrerPath = toArchivePath(document.referrer);
          if (archiveReferrerPath) {
            window.location.assign(archiveReferrerPath);
          } else {
            window.history.back();
          }
          return;
        }

        event.preventDefault();
        window.location.assign(archiveRoot);
      });
    }
  </script>
</Layout>
